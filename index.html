<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ—¥å¸¸ç‚¹æ¤œè¡¨ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ </title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: #f5f5f5;
            padding-bottom: 80px;
        }
        
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            text-align: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .header h1 { font-size: 24px; margin-bottom: 5px; }
        
        .container {
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .tab-buttons {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            background: white;
            padding: 10px;
            border-radius: 10px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        
        .tab-btn {
            flex: 1;
            padding: 12px;
            border: none;
            background: #f0f0f0;
            border-radius: 8px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .tab-btn.active { background: #667eea; color: white; }
        
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        
        .card {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        
        .form-group { margin-bottom: 15px; }
        
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #333;
            font-size: 14px;
        }
        
        input, select {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
        }
        
        input[type="number"] { -moz-appearance: textfield; }
        input:read-only { background-color: #f8f9fa; color: #495057; }
        
        .info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .info-grid-2col {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .auto-calc {
            background: #e7f3ff;
            border-color: #2196F3;
            font-weight: 600;
        }
        
        .inspection-section {
            margin-top: 20px;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            overflow: hidden;
        }
        
        .section-header {
            background: #667eea;
            color: white;
            padding: 12px 15px;
            font-weight: 600;
            font-size: 15px;
        }
        
        .inspection-table {
            width: 100%;
            border-collapse: collapse;
        }
        
        .inspection-table th {
            background: #f8f9fa;
            padding: 10px;
            text-align: left;
            font-size: 13px;
            border-bottom: 2px solid #dee2e6;
        }
        
        .inspection-table td {
            padding: 12px 10px;
            border-bottom: 1px solid #f0f0f0;
        }
        
        .check-buttons { display: flex; gap: 8px; }
        
        .check-btn {
            flex: 1;
            padding: 8px;
            border: 2px solid #ddd;
            background: white;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s;
        }
        
        .check-btn.selected-ok {
            border-color: #28a745;
            background: #d4edda;
            color: #155724;
            font-weight: 600;
        }
        
        .check-btn.selected-ng {
            border-color: #dc3545;
            background: #f8d7da;
            color: #721c24;
            font-weight: 600;
        }
        
        .btn {
            width: 100%;
            padding: 15px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            margin-top: 10px;
        }
        
        .btn-primary { background: #667eea; color: white; }
        .btn-success { background: #28a745; color: white; }
        .btn-danger { background: #dc3545; color: white; }
        
        .section-title {
            font-size: 16px;
            font-weight: 600;
            color: #667eea;
            margin: 25px 0 15px 0;
            padding-bottom: 8px;
            border-bottom: 2px solid #667eea;
        }
        
        .history-item {
            background: white;
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 8px;
            border-left: 4px solid #28a745;
        }
        
        .history-item.abnormal { border-left-color: #dc3545; }
        
        .search-box {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        
        .search-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 10px;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }
        
        .sync-status {
            display: inline-block;
            padding: 6px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
            margin-left: 10px;
        }
        
        .sync-online { background: #d4edda; color: #155724; }
        .sync-offline { background: #f8d7da; color: #721c24; }
        
        .action-buttons {
            display: flex;
            gap: 5px;
            margin-top: 10px;
        }
        
        .action-buttons button {
            flex: 1;
            padding: 8px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 13px;
        }
        
        @media (max-width: 600px) {
            .info-grid-2col { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>ğŸš— æ—¥å¸¸ç‚¹æ¤œè¡¨ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ </h1>
        <p>ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆé€£æºç‰ˆ <span id="syncStatus" class="sync-status sync-online">â— ã‚ªãƒ³ãƒ©ã‚¤ãƒ³</span></p>
    </div>
    
    <div class="container">
        <div class="tab-buttons">
            <button class="tab-btn active" onclick="switchTab('new')">æ–°è¦ç‚¹æ¤œ</button>
            <button class="tab-btn" onclick="switchTab('history')">ç‚¹æ¤œå±¥æ­´</button>
            <button class="tab-btn" onclick="switchTab('export')">Excelå‡ºåŠ›</button>
        </div>
        
        <!-- æ–°è¦ç‚¹æ¤œã‚¿ãƒ– -->
        <div id="tab-new" class="tab-content active">
            <div class="card">
                <h2 id="formTitle">æ–°è¦ç‚¹æ¤œå…¥åŠ›</h2>
                
                <form id="inspectionForm" onsubmit="saveInspection(event)">
                    <div class="section-title">åŸºæœ¬æƒ…å ±</div>
                    <div class="info-grid">
                        <div class="form-group">
                            <label>ç‚¹æ¤œæ—¥ <span style="color: red;">*</span></label>
                            <input type="date" id="inspectionDate" required>
                        </div>
                        
                        <div class="form-group">
                            <label>ç™»éŒ²ç•ªå·ãƒ»è»Šç•ª <span style="color: red;">*</span></label>
                            <input type="text" id="vehicleNumber" placeholder="ä¾‹: å“å·500ã‚1234" required>
                        </div>
                        
                        <div class="form-group">
                            <label>è¡Œå…ˆ</label>
                            <input type="text" id="destination" placeholder="ä¾‹: â—‹â—‹ç¾å ´">
                        </div>
                        
                        <div class="form-group">
                            <label>å·¥ç•ª</label>
                            <input type="text" id="projectNumber" placeholder="ä¾‹: 2024-001">
                        </div>
                    </div>
                    
                    <div class="section-title">é‹è»¢ãƒ»ç‚¹æ¤œè€…</div>
                    <div class="info-grid-2col">
                        <div class="form-group">
                            <label>é‹è»¢è€… <span style="color: red;">*</span></label>
                            <input type="text" id="driverName" required>
                        </div>
                        
                        <div class="form-group">
                            <label>ç‚¹æ¤œå®Ÿæ–½è€… <span style="color: red;">*</span></label>
                            <input type="text" id="inspectorName" required>
                        </div>
                    </div>
                    
                    <div class="section-title">ç‡ƒæ–™ãƒ»ã‚ªã‚¤ãƒ«</div>
                    <div class="info-grid-2col">
                        <div class="form-group">
                            <label>ç‡ƒæ–™çµ¦æ²¹é‡ (L)</label>
                            <input type="number" id="fuelAmount" step="0.1" min="0">
                        </div>
                        
                        <div class="form-group">
                            <label>ã‚ªã‚¤ãƒ«çµ¦æ²¹é‡ (L)</label>
                            <input type="number" id="oilAmount" step="0.1" min="0">
                        </div>
                    </div>
                    
                    <div class="section-title">èµ°è¡Œè·é›¢ï¼ˆä»»æ„ï¼‰</div>
                    <div class="info-grid">
                        <div class="form-group">
                            <label>å‰å›ç·è·é›¢ (km)</label>
                            <small style="color: #666;">å‰ã®æ—¥ã®èµ°è¡Œè·é›¢</small>
                            <input type="number" id="previousOdometer" step="0.1" min="0" onchange="calculateDistance()">
                        </div>
                        
                        <div class="form-group">
                            <label>ä»Šå›ç·è·é›¢ (km)</label>
                            <small style="color: #666;">ç‚¹æ¤œæ™‚ã®èµ°è¡Œè·é›¢</small>
                            <input type="number" id="currentOdometer" step="0.1" min="0" onchange="calculateDistance()">
                        </div>
                        
                        <div class="form-group">
                            <label>èµ°è¡Œè·é›¢ (km)</label>
                            <small style="color: #666;">è‡ªå‹•è¨ˆç®—ï¼ˆä»Šå› - å‰å›ï¼‰</small>
                            <input type="number" id="travelDistance" step="0.1" readonly class="auto-calc">
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label>é‹è¡Œä¸­ã®ç•°çŠ¶ç®‡æ‰€</label>
                        <input type="text" id="abnormalLocation">
                    </div>
                    
                    <div id="inspectionSections"></div>
                    
                    <button type="submit" class="btn btn-primary" id="submitBtn">âœ“ ç‚¹æ¤œã‚’ä¿å­˜</button>
                    <button type="button" class="btn" style="background:#6c757d;color:white;" onclick="cancelEdit()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                </form>
            </div>
        </div>
        
        <!-- ç‚¹æ¤œå±¥æ­´ã‚¿ãƒ– -->
        <div id="tab-history" class="tab-content">
            <div class="card">
                <h2>ç‚¹æ¤œå±¥æ­´ï¼ˆå…¨å“¡å…±æœ‰ï¼‰</h2>
                
                <div class="search-box">
                    <h3 style="margin-bottom: 10px;">ğŸ” æ¤œç´¢</h3>
                    <div class="search-grid">
                        <input type="date" id="searchDate" placeholder="ç‚¹æ¤œæ—¥">
                        <input type="text" id="searchVehicle" placeholder="è»Šä¸¡ç•ªå·">
                        <input type="text" id="searchDriver" placeholder="é‹è»¢è€…">
                        <button class="btn btn-primary" onclick="searchHistory()" style="padding: 10px;">æ¤œç´¢</button>
                    </div>
                </div>
                
                <div id="historyList" class="loading">èª­ã¿è¾¼ã¿ä¸­...</div>
            </div>
        </div>
        
        <!-- Excelå‡ºåŠ›ã‚¿ãƒ– -->
        <div id="tab-export" class="tab-content">
            <div class="card">
                <h2>ğŸ“Š æœˆæ¬¡Excelå‡ºåŠ›</h2>
                
                <div style="display: flex; gap: 10px; margin-bottom: 15px; align-items: center;">
                    <label>å‡ºåŠ›æœˆ:</label>
                    <input type="month" id="exportMonth" style="width: 200px;">
                    <button class="btn btn-success" onclick="exportMonthlyExcel()" style="width: auto; padding: 10px 20px; margin: 0;">
                        ğŸ“— æœˆæ¬¡Excelå‡ºåŠ›
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
// Google Apps Scriptã®URL
const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbypMT9HMEzoMRPAhjah6r1i3_imWpGUMDFc9RPg8m134Z8DXzG2NIdeYUThmNx7wqedJQ/exec';

let allHistory = [];
let editingTimestamp = null; // ç·¨é›†ä¸­ã®ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—

// ç‚¹æ¤œé …ç›®å®šç¾©
const inspectionSections = [
    {
        title: 'é‹è»¢å¸­ã§ã®ç‚¹æ¤œ',
        items: [
            { name: 'ãƒ–ãƒ¬ãƒ¼ã‚­ãƒ»ãƒšãƒ€ãƒ«', detail: 'è¸ã¿ã—ã‚ã€ãƒ–ãƒ¬ãƒ¼ã‚­ã®ãã' },
            { name: 'é§è»Šãƒ–ãƒ¬ãƒ¼ã‚­ãƒ»ãƒ¬ãƒãƒ¼', detail: 'å¼•ãã—ã‚ï¼ˆè¸ã¿ã—ã‚ï¼‰' },
            { name: 'åŸå‹•æ©Ÿï¼ˆã‚¨ãƒ³ã‚¸ãƒ³ï¼‰', detail: 'ã‹ã‹ã‚Šå…·åˆã€ç•°éŸ³' },
            { name: 'ã‚¦ã‚£ãƒ³ãƒ‰ãƒ»ã‚¦ã‚©ãƒƒã‚·ãƒ£', detail: 'å™´å°„çŠ¶æ…‹' },
            { name: 'ãƒ¯ã‚¤ãƒ‘ãƒ¼', detail: 'æ‹­ãå–ã‚Šã®çŠ¶æ…‹' }
        ]
    },
    {
        title: 'ã‚¨ãƒ³ã‚¸ãƒ³ãƒ»ãƒ«ãƒ¼ãƒ ã®ç‚¹æ¤œ',
        items: [
            { name: 'ã‚¦ã‚©ãƒƒã‚·ãƒ£ãƒ»ã‚¿ãƒ³ã‚¯', detail: 'æ¶²é‡' },
            { name: 'ãƒ–ãƒ¬ãƒ¼ã‚­ã®ãƒªã‚¶ãƒ¼ãƒãƒ»ã‚¿ãƒ³ã‚¯', detail: 'æ¶²é‡' },
            { name: 'ãƒãƒƒãƒ†ãƒª', detail: 'æ¶²é‡' },
            { name: 'ãƒ©ã‚¸ã‚¨ãƒ¼ã‚¿', detail: 'æ°´é‡' },
            { name: 'æ½¤æ»‘è£…ç½®', detail: 'ã‚¨ãƒ³ã‚¸ãƒ³ãƒ»ã‚ªã‚¤ãƒ«ã®é‡' },
            { name: 'ãƒ•ã‚¡ãƒ³ãƒ»ãƒ™ãƒ«ãƒˆ', detail: 'å¼µã‚Šå…·åˆã€æå‚·' }
        ]
    },
    {
        title: 'è»Šã®å‘¨ã‚Šã‹ã‚‰ã®ç‚¹æ¤œ',
        items: [
            { name: 'ç¯ç«è£…ç½®ã€æ–¹å‘æŒ‡ç¤ºå™¨', detail: 'ç‚¹ç¯ãƒ»ç‚¹æ»…å…·åˆ' },
            { name: 'ã‚¿ã‚¤ãƒ¤ï¼ˆç©ºæ°—åœ§ï¼‰', detail: 'ç©ºæ°—åœ§' },
            { name: 'ã‚¿ã‚¤ãƒ¤ï¼ˆäº€è£‚ãƒ»æå‚·ï¼‰', detail: 'äº€è£‚ã€æå‚·' },
            { name: 'ã‚¿ã‚¤ãƒ¤ï¼ˆç•°çŠ¶ãªæ‘©è€—ï¼‰', detail: 'ç•°çŠ¶ãªæ‘©è€—' },
            { name: 'ã‚¿ã‚¤ãƒ¤ï¼ˆæºã®æ·±ã•ï¼‰', detail: 'æºã®æ·±ã•' }
        ]
    }
];

document.addEventListener('DOMContentLoaded', function() {
    const today = new Date();
    const yyyy = today.getFullYear();
    const mm = String(today.getMonth() + 1).padStart(2, '0');
    const dd = String(today.getDate()).padStart(2, '0');
    document.getElementById('inspectionDate').value = `${yyyy}-${mm}-${dd}`;
    document.getElementById('exportMonth').value = `${yyyy}-${mm}`;
    
    renderInspectionForm();
    loadHistory();
});

function renderInspectionForm() {
    const container = document.getElementById('inspectionSections');
    let html = '<div class="section-title">ç‚¹æ¤œé …ç›®</div>';
    
    inspectionSections.forEach((section, sectionIdx) => {
        html += `
            <div class="inspection-section">
                <div class="section-header">${section.title}</div>
                <table class="inspection-table">
                    <thead>
                        <tr>
                            <th>ç‚¹æ¤œç®‡æ‰€</th>
                            <th>åˆ¤å®š</th>
                        </tr>
                    </thead>
                    <tbody>
        `;
        
        section.items.forEach((item, itemIdx) => {
            const itemId = `item_${sectionIdx}_${itemIdx}`;
            html += `
                <tr>
                    <td>
                        <strong>${item.name}</strong><br>
                        <small style="color: #666;">${item.detail}</small>
                    </td>
                    <td>
                        <div class="check-buttons">
                            <button type="button" class="check-btn" data-item="${itemId}" data-value="OK" onclick="selectCheck(this)">è‰¯å¥½</button>
                            <button type="button" class="check-btn" data-item="${itemId}" data-value="NG" onclick="selectCheck(this)">ç•°å¸¸</button>
                        </div>
                    </td>
                </tr>
            `;
        });
        
        html += '</tbody></table></div>';
    });
    
    container.innerHTML = html;
}

function selectCheck(button) {
    const itemId = button.dataset.item;
    document.querySelectorAll(`[data-item="${itemId}"]`).forEach(btn => {
        btn.classList.remove('selected-ok', 'selected-ng');
    });
    
    if (button.dataset.value === 'OK') {
        button.classList.add('selected-ok');
    } else {
        button.classList.add('selected-ng');
    }
}

function calculateDistance() {
    const previous = parseFloat(document.getElementById('previousOdometer').value) || 0;
    const current = parseFloat(document.getElementById('currentOdometer').value) || 0;
    
    if (current >= previous && current > 0) {
        document.getElementById('travelDistance').value = (current - previous).toFixed(1);
    }
}

async function saveInspection(event) {
    event.preventDefault();
    
    const results = {};
    let hasAbnormal = false;
    let allChecked = true;
    
    inspectionSections.forEach((section, sectionIdx) => {
        section.items.forEach((item, itemIdx) => {
            const itemId = `item_${sectionIdx}_${itemIdx}`;
            const selectedBtn = document.querySelector(`[data-item="${itemId}"].selected-ok, [data-item="${itemId}"].selected-ng`);
            
            if (!selectedBtn) {
                allChecked = false;
                return;
            }
            
            const value = selectedBtn.dataset.value;
            results[item.name] = value;
            
            if (value === 'NG') hasAbnormal = true;
        });
    });
    
    if (!allChecked) {
        alert('å…¨ã¦ã®ç‚¹æ¤œé …ç›®ã‚’ãƒã‚§ãƒƒã‚¯ã—ã¦ãã ã•ã„');
        return;
    }
    
    const inspection = {
        'ç‚¹æ¤œæ—¥': document.getElementById('inspectionDate').value,
        'è»Šä¸¡ç•ªå·': document.getElementById('vehicleNumber').value,
        'è¡Œå…ˆ': document.getElementById('destination').value,
        'å·¥ç•ª': document.getElementById('projectNumber').value,
        'é‹è»¢è€…': document.getElementById('driverName').value,
        'ç‚¹æ¤œè€…': document.getElementById('inspectorName').value,
        'ç‡ƒæ–™(L)': parseFloat(document.getElementById('fuelAmount').value) || '',
        'ã‚ªã‚¤ãƒ«(L)': parseFloat(document.getElementById('oilAmount').value) || '',
        'å‰å›ç·è·é›¢(km)': parseFloat(document.getElementById('previousOdometer').value) || '',
        'ä»Šå›ç·è·é›¢(km)': parseFloat(document.getElementById('currentOdometer').value) || '',
        'èµ°è¡Œè·é›¢(km)': parseFloat(document.getElementById('travelDistance').value) || '',
        'ç•°å¸¸ç®‡æ‰€': document.getElementById('abnormalLocation').value,
        'ç•°å¸¸æœ‰ç„¡': hasAbnormal ? 'ç•°å¸¸ã‚ã‚Š' : 'æ­£å¸¸',
        ...results
    };
    
    try {
        document.getElementById('syncStatus').textContent = 'â— é€ä¿¡ä¸­...';
        document.getElementById('syncStatus').className = 'sync-status sync-offline';
        
        if (editingTimestamp) {
            // æ›´æ–°
            await fetch(SCRIPT_URL, {
                method: 'POST',
                mode: 'no-cors',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    action: 'update',
                    timestamp: editingTimestamp,
                    data: inspection
                })
            });
            alert('âœ“ æ›´æ–°ã—ã¾ã—ãŸï¼');
        } else {
            // æ–°è¦ä¿å­˜
            await fetch(SCRIPT_URL, {
                method: 'POST',
                mode: 'no-cors',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(inspection)
            });
            
            if (hasAbnormal) {
                const abnormalItems = Object.keys(results).filter(key => results[key] === 'NG');
                alert('âš ï¸ ç•°å¸¸ãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸï¼\n\nè»Šä¸¡ç•ªå·: ' + inspection['è»Šä¸¡ç•ªå·'] + 
                      '\nç•°å¸¸é …ç›®:\n' + abnormalItems.join('\n') + 
                      '\n\nã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã«è¨˜éŒ²ã•ã‚Œã¾ã—ãŸã€‚ç®¡ç†è€…ã«é€£çµ¡ã—ã¦ãã ã•ã„ã€‚');
            } else {
                alert('âœ“ ç‚¹æ¤œãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜ã—ã¾ã—ãŸï¼');
            }
        }
        
        document.getElementById('syncStatus').textContent = 'â— ã‚ªãƒ³ãƒ©ã‚¤ãƒ³';
        document.getElementById('syncStatus').className = 'sync-status sync-online';
        
        cancelEdit();
        setTimeout(() => loadHistory(), 2000);
        
    } catch (error) {
        document.getElementById('syncStatus').textContent = 'â— ã‚ªãƒ•ãƒ©ã‚¤ãƒ³';
        document.getElementById('syncStatus').className = 'sync-status sync-offline';
        alert('ã‚¨ãƒ©ãƒ¼: ãƒ‡ãƒ¼ã‚¿ã®é€ä¿¡ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯æ¥ç¶šã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚');
    }
}

function cancelEdit() {
    editingTimestamp = null;
    document.getElementById('formTitle').textContent = 'æ–°è¦ç‚¹æ¤œå…¥åŠ›';
    document.getElementById('submitBtn').textContent = 'âœ“ ç‚¹æ¤œã‚’ä¿å­˜';
    
    document.getElementById('inspectionForm').reset();
    const today = new Date();
    const yyyy = today.getFullYear();
    const mm = String(today.getMonth() + 1).padStart(2, '0');
    const dd = String(today.getDate()).padStart(2, '0');
    document.getElementById('inspectionDate').value = `${yyyy}-${mm}-${dd}`;
    
    document.querySelectorAll('.check-btn').forEach(btn => {
        btn.classList.remove('selected-ok', 'selected-ng');
    });
}

async function loadHistory() {
    try {
        const response = await fetch(SCRIPT_URL);
        const result = await response.json();
        
        if (result.status === 'success') {
            // é‡è¤‡ã‚’é™¤å»ï¼ˆç™»éŒ²æ—¥æ™‚ã§ãƒ¦ãƒ‹ãƒ¼ã‚¯åŒ–ï¼‰
            const uniqueData = [];
            const seen = new Set();
            
            result.data.forEach(item => {
                const key = String(item['ç™»éŒ²æ—¥æ™‚']);
                if (key && !seen.has(key)) {
                    seen.add(key);
                    uniqueData.push(item);
                }
            });
            
            allHistory = uniqueData;
            displayHistory(allHistory);
        }
    } catch (error) {
        document.getElementById('historyList').innerHTML = '<p style="color: #dc3545;">ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ</p>';
    }
}

function displayHistory(data) {
    const container = document.getElementById('historyList');
    
    if (data.length === 0) {
        container.innerHTML = '<p style="text-align: center; color: #999; padding: 40px;">ã¾ã ç‚¹æ¤œå±¥æ­´ãŒã‚ã‚Šã¾ã›ã‚“</p>';
        return;
    }
    
    let html = '';
    data.slice().reverse().forEach(item => {
        const borderClass = item['ç•°å¸¸æœ‰ç„¡'] === 'ç•°å¸¸ã‚ã‚Š' ? 'abnormal' : '';
        const timestamp = String(item['ç™»éŒ²æ—¥æ™‚']);
        
        html += `
            <div class="history-item ${borderClass}">
                <div style="font-weight: 600; margin-bottom: 5px;">${item['ç‚¹æ¤œæ—¥']}</div>
                <div style="color: #666; font-size: 14px;">
                    ğŸš— ${item['è»Šä¸¡ç•ªå·']} | ğŸ‘¤ ${item['é‹è»¢è€…']} | ç‚¹æ¤œ: ${item['ç‚¹æ¤œè€…']}
                </div>
                <div style="color: #666; font-size: 13px; margin-top: 3px;">
                    ğŸ“ ${item['è¡Œå…ˆ'] || '-'} | å·¥ç•ª: ${item['å·¥ç•ª'] || '-'}
                </div>
                ${item['ç•°å¸¸æœ‰ç„¡'] === 'ç•°å¸¸ã‚ã‚Š' ? `<div style="color: #dc3545; font-weight: 600; margin-top: 5px;">âš ï¸ ${item['ç•°å¸¸ç®‡æ‰€']}</div>` : ''}
                <div class="action-buttons">
                    <button class="btn-primary" onclick='editInspection(${JSON.stringify(timestamp)})'>âœï¸ ç·¨é›†</button>
                    <button class="btn-danger" onclick='deleteInspection(${JSON.stringify(timestamp)})'>ğŸ—‘ï¸ å‰Šé™¤</button>
                </div>
            </div>
        `;
    });
    
    container.innerHTML = html;
}

function editInspection(timestamp) {
    const item = allHistory.find(h => String(h['ç™»éŒ²æ—¥æ™‚']) === String(timestamp));
    if (!item) return;
    
    editingTimestamp = timestamp;
    document.getElementById('formTitle').textContent = 'âœï¸ ç‚¹æ¤œã‚’ç·¨é›†';
    document.getElementById('submitBtn').textContent = 'ğŸ’¾ æ›´æ–°';
    
    // ãƒ•ã‚©ãƒ¼ãƒ ã«ãƒ‡ãƒ¼ã‚¿ã‚’å…¥åŠ›
    document.getElementById('inspectionDate').value = item['ç‚¹æ¤œæ—¥'] || '';
    document.getElementById('vehicleNumber').value = item['è»Šä¸¡ç•ªå·'] || '';
    document.getElementById('destination').value = item['è¡Œå…ˆ'] || '';
    document.getElementById('projectNumber').value = item['å·¥ç•ª'] || '';
    document.getElementById('driverName').value = item['é‹è»¢è€…'] || '';
    document.getElementById('inspectorName').value = item['ç‚¹æ¤œè€…'] || '';
    document.getElementById('fuelAmount').value = item['ç‡ƒæ–™(L)'] || '';
    document.getElementById('oilAmount').value = item['ã‚ªã‚¤ãƒ«(L)'] || '';
    document.getElementById('previousOdometer').value = item['å‰å›ç·è·é›¢(km)'] || '';
    document.getElementById('currentOdometer').value = item['ä»Šå›ç·è·é›¢(km)'] || '';
    document.getElementById('travelDistance').value = item['èµ°è¡Œè·é›¢(km)'] || '';
    document.getElementById('abnormalLocation').value = item['ç•°å¸¸ç®‡æ‰€'] || '';
    
    // ç‚¹æ¤œé …ç›®ã‚’å¾©å…ƒ
    inspectionSections.forEach((section, sectionIdx) => {
        section.items.forEach((checkItem, itemIdx) => {
            const itemId = `item_${sectionIdx}_${itemIdx}`;
            const value = item[checkItem.name];
            
            document.querySelectorAll(`[data-item="${itemId}"]`).forEach(btn => {
                btn.classList.remove('selected-ok', 'selected-ng');
                if (btn.dataset.value === value) {
                    btn.classList.add(value === 'OK' ? 'selected-ok' : 'selected-ng');
                }
            });
        });
    });
    
    switchTab('new');
    window.scrollTo(0, 0);
}

async function deleteInspection(timestamp) {
    if (!confirm('ã“ã®ç‚¹æ¤œè¨˜éŒ²ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) return;
    
    try {
        await fetch(SCRIPT_URL, {
            method: 'POST',
            mode: 'no-cors',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                action: 'delete',
                timestamp: timestamp
            })
        });
        
        alert('å‰Šé™¤ã—ã¾ã—ãŸ');
        setTimeout(() => loadHistory(), 2000);
    } catch (error) {
        alert('å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ');
    }
}

async function searchHistory() {
    const searchDate = document.getElementById('searchDate').value;
    const searchVehicle = document.getElementById('searchVehicle').value;
    const searchDriver = document.getElementById('searchDriver').value;
    
    let filtered = allHistory;
    
    if (searchDate) {
        filtered = filtered.filter(item => item['ç‚¹æ¤œæ—¥'] === searchDate);
    }
    if (searchVehicle) {
        filtered = filtered.filter(item => String(item['è»Šä¸¡ç•ªå·']).includes(searchVehicle));
    }
    if (searchDriver) {
        filtered = filtered.filter(item => String(item['é‹è»¢è€…']).includes(searchDriver));
    }
    
    displayHistory(filtered);
}

function exportMonthlyExcel() {
    const monthStr = document.getElementById('exportMonth').value;
    if (!monthStr) {
        alert('å‡ºåŠ›ã™ã‚‹æœˆã‚’é¸æŠã—ã¦ãã ã•ã„');
        return;
    }
    
    const [year, month] = monthStr.split('-');
    const daysInMonth = new Date(year, month, 0).getDate();
    
    const monthData = allHistory.filter(item => {
        const itemDate = item['ç‚¹æ¤œæ—¥'];
        return itemDate && itemDate.startsWith(monthStr);
    });
    
    if (monthData.length === 0) {
        alert('é¸æŠã—ãŸæœˆã®ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“');
        return;
    }
    
    const vehicleGroups = {};
    monthData.forEach(item => {
        const vehicleNum = item['è»Šä¸¡ç•ªå·'];
        if (!vehicleGroups[vehicleNum]) {
            vehicleGroups[vehicleNum] = [];
        }
        vehicleGroups[vehicleNum].push(item);
    });
    
    const wb = XLSX.utils.book_new();
    
    Object.keys(vehicleGroups).forEach(vehicleNum => {
        const vehicleData = vehicleGroups[vehicleNum];
        
        const dataByDate = {};
        vehicleData.forEach(item => {
            const day = parseInt(item['ç‚¹æ¤œæ—¥'].split('-')[2]);
            dataByDate[day] = item;
        });
        
        const sheetData = [];
        sheetData.push([`${year}å¹´${month}æœˆåˆ† æ—¥å¸¸ç‚¹æ¤œè¡¨ - ${vehicleNum}`]);
        sheetData.push([]);
        sheetData.push(['æœˆæ—¥', 'è¡Œå…ˆ', 'å·¥ç•ª', 'ç‡ƒæ–™(L)', 'ã‚ªã‚¤ãƒ«(L)', 'å‰å›ç·è·é›¢(km)', 'ä»Šå›ç·è·é›¢(km)', 'èµ°è¡Œ(km)', 'é‹è»¢è€…', 'ç•°å¸¸æœ‰ç„¡', 'å‚™è€ƒ']);
        
        for (let day = 1; day <= daysInMonth; day++) {
            const dayData = dataByDate[day];
            if (dayData) {
                sheetData.push([
                    `${month}/${day}`,
                    dayData['è¡Œå…ˆ'] || '',
                    dayData['å·¥ç•ª'] || '',
                    dayData['ç‡ƒæ–™(L)'] || '',
                    dayData['ã‚ªã‚¤ãƒ«(L)'] || '',
                    dayData['å‰å›ç·è·é›¢(km)'] || '',
                    dayData['ä»Šå›ç·è·é›¢(km)'] || '',
                    dayData['èµ°è¡Œè·é›¢(km)'] || '',
                    dayData['é‹è»¢è€…'] || '',
                    dayData['ç•°å¸¸æœ‰ç„¡'] || 'æ­£å¸¸',
                    dayData['ç•°å¸¸ç®‡æ‰€'] || ''
                ]);
            } else {
                sheetData.push([`${month}/${day}`, '', '', '', '', '', '', '', '', '', '']);
            }
        }
        
        sheetData.push([]);
        sheetData.push(['å·¥ç•ªåˆ¥ç¨¼åƒæ—¥æ•°']);
        sheetData.push(['å·¥ç•ª', 'ç¨¼åƒæ—¥æ•°']);
        
        const projectCounts = {};
        vehicleData.forEach(item => {
            const projectNum = item['å·¥ç•ª'];
            if (projectNum) {
                projectCounts[projectNum] = (projectCounts[projectNum] || 0) + 1;
            }
        });
        
        Object.keys(projectCounts).sort().forEach(project => {
            sheetData.push([project, projectCounts[project] + 'æ—¥']);
        });
        
        const ws = XLSX.utils.aoa_to_sheet(sheetData);
        
        ws['!cols'] = [
            { wch: 7 }, { wch: 12 }, { wch: 10 }, { wch: 7 }, { wch: 7 },
            { wch: 10 }, { wch: 10 }, { wch: 8 }, { wch: 10 }, { wch: 9 }, { wch: 18 }
        ];
        
        const sheetName = String(vehicleNum).substring(0, 31);
        XLSX.utils.book_append_sheet(wb, ws, sheetName);
    });
    
    XLSX.writeFile(wb, `æ—¥å¸¸ç‚¹æ¤œè¡¨_${year}å¹´${month}æœˆ.xlsx`);
    alert('Excelãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¾ã—ãŸï¼');
}

function switchTab(tab) {
    document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
    document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
    
    const buttons = document.querySelectorAll('.tab-btn');
    const tabs = ['new', 'history', 'export'];
    const index = tabs.indexOf(tab);
    buttons[index].classList.add('active');
    
    document.getElementById('tab-' + tab).classList.add('active');
    
    if (tab === 'history') {
        loadHistory();
    }
}
    </script>
</body>
</html>
